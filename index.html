<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÇ¨Í≥º Ìï©Í≥Ñ Í≤åÏûÑ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            overscroll-behavior: none;
            background-color: #f0fdf4; /* Light green background */
        }
        .apple {
            width: 40px;
            height: 40px;
            background-image: linear-gradient(to bottom, #f87171, #dc2626); /* Gradient for apple */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); /* Text shadow */
            cursor: default;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            border: 1px solid #b91c1c; /* Darker border */
            box-shadow: inset 0 -4px 5px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.2); /* Inner and outer shadow */
            position: relative;
            transition: transform 0.15s ease-out, opacity 0.3s ease-out; /* Adjusted transitions */
            touch-action: none;
        }
        /* ÎìúÎûòÍ∑∏ ÏÉÅÏûê ÏïàÏóê Îì§Ïñ¥ÏôîÏùÑ Îïå Ìö®Í≥º */
        .apple.in-selection-box {
            transform: scale(1.1);
            box-shadow: inset 0 -4px 5px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.2), 0 0 10px rgba(255, 255, 255, 0.5); /* Add glow */
        }
        .apple.selected-for-removal {
            opacity: 0;
            transform: scale(0) rotate(360deg); /* Add rotation on removal */
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-out;
        }
        .apple-placeholder {
             width: 40px;
             height: 40px;
             visibility: hidden;
        }
        #selection-box {
            position: absolute;
            border: 3px dashed #3b82f6; /* Thicker border */
            background-color: rgba(59, 130, 246, 0.15); /* Slightly darker */
            pointer-events: none;
            z-index: 10;
            border-radius: 8px;
            transition: border-color 0.1s, background-color 0.1s; /* Smooth transition for style change */
        }
        #selection-box.target-sum {
            border: 3px solid #ef4444;
            background-color: rgba(239, 68, 68, 0.25);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); /* Add glow when sum is 10 */
        }
        #game-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 25px; /* Increased gap */
            padding: 25px;
            flex-wrap: wrap;
        }
        #grid {
            display: grid;
            grid-template-columns: repeat(17, auto);
            gap: 8px;
            padding: 20px; /* Increased padding */
            background-color: #dcfce7; /* Lighter green */
            border-radius: 16px; /* More rounded */
            border: 4px solid #6ee7b7; /* Softer green border */
            position: relative;
            width: min-content;
            max-width: 100%;
            box-sizing: border-box;
            touch-action: none;
            cursor: grab;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Add shadow to grid */
        }
        #grid:active {
             cursor: grabbing;
        }
        #game-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px; /* Increased gap */
            padding: 25px;
            background-color: #fff; /* White background */
            border-radius: 16px;
            border: 2px solid #e5e7eb; /* Lighter gray border */
            min-width: 180px; /* Slightly wider */
            user-select: none;
            -webkit-user-select: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); /* Add subtle shadow */
        }
        .info-item { /* Class for styling info sections */
            text-align: center;
            width: 100%;
        }
        .info-label {
             font-size: 1.1rem; /* Slightly larger label */
             font-weight: 600; /* Semi-bold */
             color: #4b5563; /* Darker gray */
             margin-bottom: 4px;
        }
        .info-value {
             font-size: 2rem; /* Larger value */
             font-weight: 700; /* Bold */
        }
        #score.info-value { color: #2563eb; } /* Blue score */
        #apples-left.info-value { color: #dc2626; } /* Red apples left */
        #time.info-value { color: #059669; } /* Green time */
        #time.low-time { color: #dc2626 !important; } /* Red when time is low */
        #combo-counter { /* Combo display style */
            font-size: 1.5rem;
            font-weight: bold;
            color: #f59e0b; /* Amber color */
            margin-top: 10px;
            height: 30px; /* Reserve space */
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0; /* Hidden by default */
            transform: translateY(10px);
        }
        #combo-counter.visible {
            opacity: 1;
            transform: translateY(0);
        }

        #timer-gauge-container {
            width: 20px;
            height: 250px; /* Slightly shorter */
            background-color: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #d1d5db;
            margin-top: 8px; /* Added margin */
        }
        #timer-gauge {
            width: 100%;
            height: 100%;
            background-color: #10b981;
            transition: height 0.5s linear, background-color 0.3s; /* Added background transition */
            border-radius: 10px 10px 0 0;
        }
        .game-button {
            padding: 12px 24px; /* Larger padding */
            background-image: linear-gradient(to bottom, #3b82f6, #2563eb); /* Gradient */
            color: white;
            border: none;
            border-radius: 10px; /* More rounded */
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin-top: 10px; /* Added margin */
        }
        .game-button:hover {
            background-image: linear-gradient(to bottom, #2563eb, #1d4ed8); /* Darker gradient */
        }
         .game-button:active {
             transform: translateY(1px); /* Button press effect */
             box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
         }
        /* Responsive adjustments */
        @media (max-width: 1024px) {
             #grid {
                grid-template-columns: repeat(10, auto);
                gap: 6px;
             }
             .apple, .apple-placeholder {
                 width: 35px;
                 height: 35px;
                 font-size: 14px;
             }
             #game-container {
                 flex-direction: column;
                 align-items: center;
             }
             #game-info {
                 flex-direction: row;
                 width: 90%;
                 justify-content: space-around;
                 flex-wrap: wrap;
                 gap: 15px; /* Adjust gap for row layout */
             }
              .info-item { width: auto; } /* Allow items to size naturally */
             #timer-gauge-container {
                 width: 150px; /* Wider horizontal gauge */
                 height: 20px;
             }
             #timer-gauge {
                 height: 100%;
                 width: 100%;
                 transition: width 0.5s linear, background-color 0.3s;
                 border-radius: 10px 0 0 10px;
             }
             #combo-counter { margin-top: 0; }
        }
         @media (max-width: 640px) {
             #grid {
                grid-template-columns: repeat(8, auto);
                gap: 4px;
                padding: 10px;
             }
             .apple, .apple-placeholder {
                 width: 30px;
                 height: 30px;
                 font-size: 12px;
             }
             #game-info {
                 flex-direction: column;
                 align-items: center;
                 gap: 10px;
                 width: 95%;
             }
             .info-item { width: 100%; } /* Stack vertically again */
             #timer-gauge-container {
                 width: 80%;
                 height: 15px;
             }
             .game-button {
                 padding: 10px 20px;
             }
             .info-label { font-size: 1rem; }
             .info-value { font-size: 1.75rem; }
             #combo-counter { font-size: 1.25rem; }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <h1 class="text-3xl font-bold mb-6 text-gray-800">ÏÇ¨Í≥º Ìï©Í≥Ñ Í≤åÏûÑ üçé</h1>

    <div id="game-container">
        <div id="grid">
            </div>
        <div id="game-info">
            <div class="info-item">
                <div class="info-label">Ï†êÏàò</div>
                <div id="score" class="info-value">0</div>
            </div>
             <div class="info-item">
                <div class="info-label">ÎÇ®ÏùÄ ÏÇ¨Í≥º</div>
                <div id="apples-left" class="info-value">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">ÎÇ®ÏùÄ ÏãúÍ∞Ñ</div>
                <div id="time" class="info-value">120</div>
                <div id="timer-gauge-container">
                    <div id="timer-gauge"></div>
                </div>
            </div>
             <div class="info-item"> <div class="info-label">ÏΩ§Î≥¥</div>
                 <div id="combo-counter"></div>
             </div>
             <button id="reset-button" class="game-button">Îã§Ïãú ÏãúÏûë</button>
        </div>
    </div>

    <div id="selection-box" style="display: none;"></div>

    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center" style="display: none; z-index: 100;">
        <div class="bg-white p-10 rounded-xl shadow-2xl text-center max-w-sm w-full mx-4">
            <p id="message-text" class="text-2xl font-bold mb-6 text-gray-800"></p>
            <button id="close-message-button" class="game-button">ÌôïÏù∏</button>
        </div>
    </div>

    <script>
        // --- Game Settings ---
        const GRID_ROWS = 10;
        const GRID_COLS = 17;
        const TARGET_SUM = 10;
        const GAME_DURATION_SECONDS = 120;
        const COMBO_TIMEOUT_MS = 2000; // ÏΩ§Î≥¥ Ïú†ÏßÄ ÏãúÍ∞Ñ (2Ï¥à)
        const COMBO_BONUS_BASE = 1; // ÏΩ§Î≥¥Îãπ Ï∂îÍ∞Ä Ï†êÏàò

        // --- DOM Elements ---
        const gridElement = document.getElementById('grid');
        const scoreElement = document.getElementById('score');
        const timeElement = document.getElementById('time');
        const applesLeftElement = document.getElementById('apples-left');
        const timerGaugeElement = document.getElementById('timer-gauge');
        const timerGaugeContainer = document.getElementById('timer-gauge-container');
        const selectionBoxElement = document.getElementById('selection-box');
        const resetButton = document.getElementById('reset-button');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const closeMessageButton = document.getElementById('close-message-button');
        const comboCounterElement = document.getElementById('combo-counter'); // ÏΩ§Î≥¥ Ïπ¥Ïö¥ÌÑ∞ ÏöîÏÜå

        // --- Game State Variables ---
        let apples = [];
        let score = 0;
        let timeLeft = GAME_DURATION_SECONDS;
        let timerInterval = null;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let currentPointerId = null;
        let selectionRect = { x: 0, y: 0, width: 0, height: 0 };
        let selectedApplesData = [];
        let currentSum = 0;
        let isGameOver = false;
        let totalApples = GRID_ROWS * GRID_COLS;
        let applesRemaining = totalApples;
        let comboCount = 0; // ÌòÑÏû¨ ÏΩ§Î≥¥ Ïàò
        let lastClearTime = 0; // ÎßàÏßÄÎßâÏúºÎ°ú ÏÇ¨Í≥ºÎ•º Ï†úÍ±∞Ìïú ÏãúÍ∞Ñ
        let comboTimeout = null; // ÏΩ§Î≥¥ Ï¥àÍ∏∞Ìôî ÌÉÄÏù¥Î®∏

        // --- Sound Effects (Tone.js) ---
        let soundsReady = false;
        let successSound, gameOverSound, comboSound;

        // ÏÇ¨Ïö¥Îìú Ï¥àÍ∏∞Ìôî Ìï®Ïàò (ÏÇ¨Ïö©Ïûê ÏÉÅÌò∏ÏûëÏö© ÌõÑ Ìò∏Ï∂ú ÌïÑÏöî)
        async function initSounds() {
            if (soundsReady) return;
            try {
                await Tone.start(); // Ïò§ÎîîÏò§ Ïª®ÌÖçÏä§Ìä∏ ÏãúÏûë
                successSound = new Tone.Synth({
                    oscillator: { type: 'triangle' },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 }
                }).toDestination();
                 comboSound = new Tone.Synth({ // ÏΩ§Î≥¥ ÏÇ¨Ïö¥Îìú
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.005, decay: 0.05, sustain: 0.0, release: 0.1 }
                }).toDestination();
                gameOverSound = new Tone.Synth({
                     oscillator: { type: 'square' },
                     envelope: { attack: 0.01, decay: 0.3, sustain: 0.0, release: 0.2 }
                 }).toDestination();
                soundsReady = true;
                console.log("Sounds initialized successfully.");
            } catch (e) {
                console.error("Failed to initialize sounds:", e);
                // ÏÇ¨Ïö¥Îìú ÏóÜÏù¥ Í≤åÏûÑ ÏßÑÌñâ Í∞ÄÎä•ÌïòÎèÑÎ°ù Ï≤òÎ¶¨
            }
        }

        // --- Functions ---

        /** Î©îÏãúÏßÄ Î∞ïÏä§Î•º ÌëúÏãúÌïòÎäî Ìï®Ïàò */
        function showMessage(message) {
            messageText.textContent = message;
            messageBox.style.display = 'flex';
        }

        /** Î©îÏãúÏßÄ Î∞ïÏä§Î•º Ïà®Í∏∞Îäî Ìï®Ïàò */
        function hideMessage() {
            messageBox.style.display = 'none';
        }

        /** Í≤åÏûÑ Ï¥àÍ∏∞Ìôî Î∞è ÏãúÏûë */
        function initGame() {
            // ÏÇ¨Ïö¥Îìú Ï¥àÍ∏∞Ìôî (Ï≤´ ÏÇ¨Ïö©Ïûê Ïù∏ÌÑ∞ÎûôÏÖò Ïãú ÌïÑÏöî)
             if (!soundsReady) {
                 // Add a temporary button or interaction prompt if needed
                 // For simplicity, we assume interaction happens before game logic needs sound
                 console.log("Sound context needs user interaction to start.");
             }

            isGameOver = false;
            score = 0;
            timeLeft = GAME_DURATION_SECONDS;
            apples = [];
            applesRemaining = totalApples;
            comboCount = 0; // ÏΩ§Î≥¥ Ï¥àÍ∏∞Ìôî
            lastClearTime = 0;
            clearTimeout(comboTimeout); // ÏΩ§Î≥¥ ÌÉÄÏù¥Î®∏ Ï†úÍ±∞
            updateComboDisplay(); // ÏΩ§Î≥¥ ÌëúÏãú Ï¥àÍ∏∞Ìôî

            gridElement.innerHTML = '';
            selectionBoxElement.style.display = 'none';
            isDragging = false;
            currentPointerId = null;
            updateScore();
            updateTimerDisplay();
            updateApplesLeftDisplay();
            resetTimerGauge();

            // Í∑∏Î¶¨Îìú ÏÉùÏÑ± Î∞è ÏÇ¨Í≥º Ï±ÑÏö∞Í∏∞
            gridElement.style.gridTemplateColumns = `repeat(${GRID_COLS}, auto)`;
            for (let r = 0; r < GRID_ROWS; r++) {
                apples[r] = [];
                for (let c = 0; c < GRID_COLS; c++) {
                    createApple(r, c);
                }
            }

            // ÌÉÄÏù¥Î®∏ ÏãúÏûë
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);

            hideMessage();
            console.log("Game Initialized");
        }

        /** ÌäπÏ†ï ÏúÑÏπòÏóê ÏÇ¨Í≥º ÏÉùÏÑ± */
        function createApple(row, col) {
            const appleValue = Math.floor(Math.random() * 9) + 1;
            const appleElement = document.createElement('div');
            appleElement.classList.add('apple');
            appleElement.textContent = appleValue;
            appleElement.dataset.row = row;
            appleElement.dataset.col = col;
            appleElement.dataset.value = appleValue;

            gridElement.appendChild(appleElement);
            apples[row][col] = { element: appleElement, value: appleValue, row: row, col: col };
        }

        /** Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏ */
        function updateScore() {
            scoreElement.textContent = score;
        }

        /** ÎÇ®ÏùÄ ÏÇ¨Í≥º Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏ */
        function updateApplesLeftDisplay() {
            applesLeftElement.textContent = applesRemaining;
        }

        /** ÏΩ§Î≥¥ Ïπ¥Ïö¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ */
        function updateComboDisplay() {
            if (comboCount > 1) { // 2ÏΩ§Î≥¥ Ïù¥ÏÉÅÏùº ÎïåÎßå ÌëúÏãú
                comboCounterElement.textContent = `${comboCount} COMBO!`;
                comboCounterElement.classList.add('visible');
                 // ÏΩ§Î≥¥ Î†àÎ≤®Ïóê Îî∞Îùº ÌîºÏπò Ï°∞Ï†à (ÏòàÏãú)
                 if (soundsReady && comboSound) {
                     const pitch = Tone.Frequency("C4").transpose((comboCount - 1) * 2); // ÏΩ§Î≥¥ÎßàÎã§ Ïùå ÎÜíÏù¥ Ïò¨Î¶º
                     comboSound.triggerAttackRelease(pitch, '8n', Tone.now());
                 }
            } else {
                comboCounterElement.classList.remove('visible');
                // comboCounterElement.textContent = ''; // ÎÇ¥Ïö© ÎπÑÏö∞Í∏∞
            }
        }

        /** ÏΩ§Î≥¥ Ï¥àÍ∏∞Ìôî ÌÉÄÏù¥Î®∏ ÏÑ§Ï†ï */
        function resetComboTimer() {
            clearTimeout(comboTimeout);
            comboTimeout = setTimeout(() => {
                comboCount = 0;
                updateComboDisplay();
                 console.log("Combo reset");
            }, COMBO_TIMEOUT_MS);
        }

        /** ÌÉÄÏù¥Î®∏ ÏóÖÎç∞Ïù¥Ìä∏ */
        function updateTimer() {
            if (isGameOver) return;

            timeLeft--;
            updateTimerDisplay();
            updateTimerGauge();

            if (timeLeft <= 0) {
                endGame("ÏãúÍ∞Ñ Ï¢ÖÎ£å!");
            }
        }

        /** ÌÉÄÏù¥Î®∏ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ */
        function updateTimerDisplay() {
             timeElement.textContent = timeLeft;
             if (timeLeft <= 10) {
                 timeElement.classList.add('low-time'); // ÏãúÍ∞Ñ Î∂ÄÏ°± ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
             } else {
                 timeElement.classList.remove('low-time');
             }
        }

        /** ÌÉÄÏù¥Î®∏ Í≤åÏù¥ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏ */
        function updateTimerGauge() {
            const percentage = Math.max(0, (timeLeft / GAME_DURATION_SECONDS) * 100); // Ensure percentage doesn't go below 0
            const isHorizontal = window.innerWidth <= 1024 && window.innerHeight > window.innerWidth;

            if (isHorizontal) {
                timerGaugeElement.style.width = `${percentage}%`;
                timerGaugeElement.style.height = '100%';
            } else {
                timerGaugeElement.style.height = `${percentage}%`;
                timerGaugeElement.style.width = '100%';
            }

            // Í≤åÏù¥ÏßÄ ÏÉâÏÉÅ Î≥ÄÍ≤Ω
            if (percentage <= 10) {
                timerGaugeElement.style.backgroundColor = '#ef4444'; // Red
            } else if (percentage <= 25) {
                timerGaugeElement.style.backgroundColor = '#f59e0b'; // Amber
            } else {
                timerGaugeElement.style.backgroundColor = '#10b981'; // Emerald
            }
        }

        /** ÌÉÄÏù¥Î®∏ Í≤åÏù¥ÏßÄ Î¶¨ÏÖã */
        function resetTimerGauge() {
            const isHorizontal = window.innerWidth <= 1024 && window.innerHeight > window.innerWidth;
            if (isHorizontal) {
                timerGaugeElement.style.width = '100%';
                timerGaugeElement.style.height = '100%';
            } else {
                timerGaugeElement.style.height = '100%';
                timerGaugeElement.style.width = '100%';
            }
            timerGaugeElement.style.backgroundColor = '#10b981'; // Reset color
        }

        /** Í≤åÏûÑ Ï¢ÖÎ£å Ï≤òÎ¶¨ */
        function endGame(reason = "Í≤åÏûÑ Ï¢ÖÎ£å!") {
            if (isGameOver) return;

            isGameOver = true;
            clearInterval(timerInterval);
            isDragging = false;
            if (currentPointerId !== null) {
                 gridElement.releasePointerCapture(currentPointerId);
                 currentPointerId = null;
            }
            selectionBoxElement.style.display = 'none';

            // Play game over sound
            if (soundsReady && gameOverSound) {
                 gameOverSound.triggerAttackRelease("C3", "0.5n", Tone.now());
            }
             clearTimeout(comboTimeout); // ÏΩ§Î≥¥ ÌÉÄÏù¥Î®∏ Ï†úÍ±∞

            console.log("Game Over!", reason);
            showMessage(`${reason} ÏµúÏ¢Ö Ï†êÏàò: ${score}`);
        }

        /** Ìè¨Ïù∏ÌÑ∞ Îã§Ïö¥ Ìï∏Îì§Îü¨ */
        function handlePointerDown(event) {
             // Initialize sounds on first user interaction
             if (!soundsReady) {
                 initSounds();
             }

             if (isGameOver || isDragging) return;

            isDragging = true;
            currentPointerId = event.pointerId;
            // Capture pointer on the element where the event originated, usually gridElement
            event.target.setPointerCapture(currentPointerId);

            dragStartX = event.pageX;
            dragStartY = event.pageY;

            selectionBoxElement.style.left = `${dragStartX}px`;
            selectionBoxElement.style.top = `${dragStartY}px`;
            selectionBoxElement.style.width = '0px';
            selectionBoxElement.style.height = '0px';
            selectionBoxElement.style.display = 'block';
            selectionBoxElement.classList.remove('target-sum');

            // Add listeners to the capturing element
            event.target.addEventListener('pointermove', handlePointerMove);
            event.target.addEventListener('pointerup', handlePointerUp);
            event.target.addEventListener('pointercancel', handlePointerUp);

            console.log("Drag Start - Pointer ID:", currentPointerId);
        }

        /** Ìè¨Ïù∏ÌÑ∞ Ïù¥Îèô Ìï∏Îì§Îü¨ */
        function handlePointerMove(event) {
            if (!isDragging || isGameOver || event.pointerId !== currentPointerId) return;

            event.preventDefault(); // Prevent scrolling while dragging

            const currentX = event.pageX;
            const currentY = event.pageY;

            const x = Math.min(dragStartX, currentX);
            const y = Math.min(dragStartY, currentY);
            const width = Math.abs(dragStartX - currentX);
            const height = Math.abs(dragStartY - currentY);

            selectionBoxElement.style.left = `${x}px`;
            selectionBoxElement.style.top = `${y}px`;
            selectionBoxElement.style.width = `${width}px`;
            selectionBoxElement.style.height = `${height}px`;

            const selectionAbsRect = { left: x, top: y, right: x + width, bottom: y + height };

            selectedApplesData = [];
            currentSum = 0;
            // Iterate through all potential apple locations
            apples.flat().forEach(appleData => {
                 if (appleData && appleData.element && gridElement.contains(appleData.element)) {
                     const isSelected = isInsideSelection(appleData.element, selectionAbsRect);
                     if (isSelected) {
                         selectedApplesData.push(appleData);
                         currentSum += appleData.value;
                         appleData.element.classList.add('in-selection-box'); // Add visual feedback class
                     } else {
                         appleData.element.classList.remove('in-selection-box'); // Remove visual feedback class
                     }
                 }
            });


            if (currentSum === TARGET_SUM) {
                selectionBoxElement.classList.add('target-sum');
            } else {
                selectionBoxElement.classList.remove('target-sum');
            }
        }

        /** Ìè¨Ïù∏ÌÑ∞ ÏóÖ Ìï∏Îì§Îü¨ */
        function handlePointerUp(event) {
            if (!isDragging || isGameOver || event.pointerId !== currentPointerId) return;

            isDragging = false;
             // Release pointer capture from the element that captured it
            event.target.releasePointerCapture(currentPointerId);
            currentPointerId = null;
            selectionBoxElement.style.display = 'none';

            // Remove listeners
            event.target.removeEventListener('pointermove', handlePointerMove);
            event.target.removeEventListener('pointerup', handlePointerUp);
            event.target.removeEventListener('pointercancel', handlePointerUp);

             // Remove 'in-selection-box' class from all apples after drag ends
             apples.flat().forEach(appleData => {
                 if (appleData && appleData.element) {
                     appleData.element.classList.remove('in-selection-box');
                 }
             });

            console.log("Drag End, Sum:", currentSum);

            if (currentSum === TARGET_SUM && selectedApplesData.length > 0) {
                const now = Date.now();
                // ÏΩ§Î≥¥ Í≥ÑÏÇ∞
                if (now - lastClearTime < COMBO_TIMEOUT_MS) {
                    comboCount++;
                } else {
                    comboCount = 1; // ÏΩ§Î≥¥ ÏãúÏûë ÎòêÎäî Î¶¨ÏÖã
                }
                lastClearTime = now;

                const baseScore = selectedApplesData.length;
                const comboBonus = comboCount > 1 ? (comboCount -1) * COMBO_BONUS_BASE : 0; // 2ÏΩ§Î≥¥Î∂ÄÌÑ∞ Î≥¥ÎÑàÏä§
                const scoreEarned = baseScore + comboBonus;

                console.log(`Target sum matched! Base: ${baseScore}, Combo: ${comboCount}, Bonus: ${comboBonus}, Total Earned: ${scoreEarned}`);

                score += scoreEarned; // Í∏∞Î≥∏ Ï†êÏàò + ÏΩ§Î≥¥ Î≥¥ÎÑàÏä§
                applesRemaining -= selectedApplesData.length;
                updateScore();
                updateApplesLeftDisplay();
                updateComboDisplay(); // ÏΩ§Î≥¥ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                resetComboTimer(); // ÏΩ§Î≥¥ Î¶¨ÏÖã ÌÉÄÏù¥Î®∏ ÏãúÏûë/Ïû¨ÏãúÏûë

                // Play success sound
                if (soundsReady && successSound) {
                    successSound.triggerAttackRelease("C5", "8n", Tone.now()); // Play a C5 note
                }

                // Ï†úÍ±∞ Ïï†ÎãàÎ©îÏù¥ÏÖò Î∞è Ï≤òÎ¶¨
                selectedApplesData.forEach(appleData => {
                    if (appleData && appleData.element && gridElement.contains(appleData.element)) {
                        const { element, row, col } = appleData;

                        element.classList.add('selected-for-removal');

                        element.addEventListener('transitionend', () => {
                            if (gridElement.contains(element)) {
                                const placeholder = document.createElement('div');
                                placeholder.classList.add('apple-placeholder');
                                if (element.parentNode === gridElement) {
                                     gridElement.replaceChild(placeholder, element);
                                }
                            }
                        }, { once: true });

                        apples[row][col] = null;
                    }
                });

                if (applesRemaining <= 0) {
                    endGame("Î™®Îì† ÏÇ¨Í≥º Ï†úÍ±∞ ÏôÑÎ£å!");
                }
            } else if (selectedApplesData.length > 0) {
                 // Ìï©Í≥ÑÍ∞Ä 10Ïù¥ ÏïÑÎãàÏßÄÎßå ÎìúÎûòÍ∑∏Î•º ÎÜìÏïòÏùÑ Îïå (ÏÑ†ÌÉù ÏÇ¨Ìï≠: Ìå®ÎÑêÌã∞ ÎòêÎäî Ìö®Í≥ºÏùå)
                 console.log("Drag ended, sum not 10.");
                 // comboCount = 0; // ÏΩ§Î≥¥ Î¶¨ÏÖã (ÏÑ†ÌÉù ÏÇ¨Ìï≠)
                 // updateComboDisplay();
            }

            selectedApplesData = [];
            currentSum = 0;
        }

        /** ÏöîÏÜåÍ∞Ä ÏÑ†ÌÉù ÏòÅÏó≠ ÏïàÏóê ÏûàÎäîÏßÄ ÌôïÏù∏ */
        function isInsideSelection(element, selectionAbsRect) {
            const elemRect = element.getBoundingClientRect();
            const elemCenterX = elemRect.left + elemRect.width / 2 + window.scrollX;
            const elemCenterY = elemRect.top + elemRect.height / 2 + window.scrollY;
            return (
                elemCenterX >= selectionAbsRect.left &&
                elemCenterX <= selectionAbsRect.right &&
                elemCenterY >= selectionAbsRect.top &&
                elemCenterY <= selectionAbsRect.bottom
            );
        }

        // --- Event Listeners ---
        gridElement.addEventListener('pointerdown', handlePointerDown);
        resetButton.addEventListener('click', initGame);
        closeMessageButton.addEventListener('click', hideMessage);
        window.addEventListener('resize', () => {
             if (!isGameOver) {
                 resetTimerGauge();
                 updateTimerGauge();
             }
        });

        // --- Game Start ---
        // initGame(); // Start game immediately
        // OR: Start game after first interaction to ensure sound context is ready
         document.body.addEventListener('pointerdown', initSounds, { once: true }); // Initialize sound on first interaction anywhere
         initGame(); // Initialize game layout etc.


    </script>

</body>
</html>
